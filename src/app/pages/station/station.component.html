<div class="station">
  <div class="topbar">
    <a class="back" routerLink="/">Back to Dashboard</a>
    <div class="title">{{ facilityName }} — Bus Management</div>
  </div>

  <section class="section" *ngFor="let c of categories">
    <div class="section-title">
      {{ c.label }} ({{ board()[c.id].length }} buses)
    </div>

    <div class="bus-card" *ngFor="let bus of board()[c.id]">
      <div class="bus-left">
        <div class="bus-name">{{ bus.label }}</div>

        <!-- no location anymore -->
        <div class="bus-meta" *ngIf="bus.bay != null">
          <b>Bay:</b> {{ bus.bay }}
        </div>

        <!-- status always matches the column -->
        <div class="bus-meta"><b>Status:</b> {{ c.label }}</div>

        <div class="bus-meta"><b>Last Service:</b> {{ bus.lastService || '--' }}</div>
        <div class="bus-meta"><b>Notes:</b> {{ bus.notes || '--' }}</div>
      </div>

      <button class="edit-btn" type="button" (click)="startEdit(c.id, bus)">Edit</button>
    </div>
  </section>

  <!-- Overlay (click outside to close) -->
  <div
    class="sheet-overlay"
    *ngIf="isSheetOpen"
    [class.visible]="isSheetVisible"
    (click)="cancelEdit()"
  ></div>

  <!-- Sheet only renders when editing exists -->
  <ng-container *ngIf="isSheetOpen && editing as e">
    <div class="sheet" [class.visible]="isSheetVisible" (click)="$event.stopPropagation()">
      <div class="sheet-header">
        <div class="sheet-title">Edit {{ e.bus.label }}</div>
        <button class="x" type="button" (click)="cancelEdit()">✕</button>
      </div>

      <div class="sheet-body">
        <label>
          Status (Category)
          <select [(ngModel)]="e.toCatId">
            <option *ngFor="let c of categories" [ngValue]="c.id">
              {{ c.label }}
            </option>
          </select>
        </label>

        <!-- show bay field ONLY for Maintenance / Long-term -->
        <label *ngIf="e.toCatId === 'maintenance' || e.toCatId === 'long_term'">
          Bay Number
          <input
            type="number"
            min="1"
            max="99"
            placeholder="e.g., 3"
            [(ngModel)]="e.bus.bay"
          />
        </label>

        <label>
          Last Service
          <input type="date" [(ngModel)]="e.bus.lastService" />
        </label>

        <label>
          Notes
          <textarea [(ngModel)]="e.bus.notes"></textarea>
        </label>
      </div>

      <div class="sheet-actions">
        <button class="btn ghost" type="button" (click)="cancelEdit()">Cancel</button>
        <button class="btn primary" type="button" (click)="saveEdit()">Save</button>
      </div>
    </div>
  </ng-container>
</div>