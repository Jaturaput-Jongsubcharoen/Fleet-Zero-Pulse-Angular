<div class="page">
  <!-- Header -->
  <header class="header">
    <h1 class="title">{{ title }}</h1>
    <div class="subtitle">{{ subtitle }}</div>
  </header>

  <!-- CONTENT WRAP: forces Facilities + Board to share same width -->
  <div class="content-wrap">
    <div class="layout layout--vertical">

      <!-- TOP ROW: Facilities (HORIZONTAL) -->
      <section class="facilities-row">
        <div class="sidebar-card">
          <div class="sidebar-title">Facilities</div>

          <div class="fac-items">
            <button
              class="fac-item"
              *ngFor="let f of facilities; trackBy: trackByFacilityId"
              [class.active]="f.id === selectedFacilityId"
              (click)="onSelectFacility(f.id)"
              type="button"
            >
              <div class="name">{{ f.name }}</div>
              <div class="count">{{ facilityTotal(f.id) }}</div>
            </button>
          </div>

          <div class="sidebar-hint">
            Tip: Drag buses between columns to change status.
          </div>
        </div>
      </section>

      <!-- BOTTOM ROW: Board -->
      <section class="board-row">
        <section class="board-shell">
          <div class="board-title">{{ selectedFacility.name }}</div>

          <div class="columns">
            <div class="col" *ngFor="let c of categories; trackBy: trackByCategoryId">
              <div class="col-card">
                <div class="col-header">
                  <span class="col-name">{{ c.label }}</span>
                  <span class="col-count">({{ count(c.id) }} buses)</span>
                </div>

                <div
                  class="dropzone"
                  cdkDropList
                  [id]="dropListId(c.id)"
                  [cdkDropListData]="board[c.id]"
                  [cdkDropListConnectedTo]="connectedDropListIds"
                  (cdkDropListDropped)="onDrop(c.id, $event)"
                >
                  <div
                    class="bus bus--img"
                    *ngFor="let bus of board[c.id]; trackBy: trackByBusId"
                    cdkDrag
                    cdkDragPreviewContainer="global"
                    (dblclick)="openBusSnapshot(bus, c.label)"
                    [style.--busImg]="'url(' + getFacilityBusImageUrl() + ')'"
                  >
                    <div class="bus-top">
                      <div class="bus-badge">{{ bus.label }}</div>
                      <div class="bus-loc">{{ bus.location }}</div>
                    </div>

                    <!-- Placeholder -->
                    <ng-template cdkDragPlaceholder>
                      <div class="bus bus--placeholder"></div>
                    </ng-template>

                    <!-- Drag preview -->
                    <ng-template cdkDragPreview>
                      <div
                        class="bus bus--img bus--preview"
                        [style.background-image]="'url(' + getFacilityBusImageUrl() + ')'"
                        style="background-size: cover; background-position: center;"
                      >
                        <div class="bus-top">
                          <div class="bus-badge">{{ bus.label }}</div>
                          <div class="bus-loc">{{ bus.location }}</div>
                        </div>
                      </div>
                    </ng-template>

                  </div>
                </div>

              </div>
            </div>
          </div>
        </section>
      </section>

    </div>
  </div>

  <!-- Snapshot Modal -->
  <app-bus-snapshot
    *ngIf="isSnapshotOpen && selectedBus"
    [bus]="selectedBus"
    (close)="closeBusSnapshot()"
    (viewFull)="closeBusSnapshot()"
  ></app-bus-snapshot>
</div>
